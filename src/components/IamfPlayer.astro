---
// IamfPlayer.astro
---

<div id="iamf-player-wrapper">
  <button id="iamf-play-button" aria-label="Play 3D Audio" disabled>
    <svg class="icon-play" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"></path></svg>
    <svg class="icon-pause" viewBox="0 0 24 24"><path d="M6 4h4v16H6zM14 4h4v16h-4z"></path></svg>
  </button>
  <p id="iamf-status">Loading Audio Engine...</p>
</div>


<div id="iamf-dummy-elements" style="display: none !important;">
  <div class="card" id="logBox"></div>
  
  <select id="demoFile" disabled>
    <option
      value="Animated demo (3rd-order ambisonics)"
      id="iamf-file-to-load"
      selected
    >
      Animated_demo_3OA
    </option>
  </select>
  <select id="outputSampleRate"><option value="48000" selected>48000 Hz</option></select>
  <input type="checkbox" id="advancedSettingsCheckbox" />
  <div id="advancedSettings"></div>
  <input type="checkbox" id="showAudioElementsCheckbox" />
  <div id="fileDrop"></div>
  <video id="videoPlayback"></video>
  <canvas id="timelineCanvas"></canvas>
  <button id="stereoButton"></button>
  <audio id="stereoPlayback"></audio>
  
  <button id="playPauseButton" disabled></button>
  
  <button id="binauralButton"></button>
  <audio id="binauralPlayback"></audio>
  <div id="fineprint"></div>
</div>

<script>
  // Importiere den Store (als .js)
  import { theme, onSet } from '../lib/stores/sceneStore';
  import { connectAudioElement, resumeAudioContext } from '../lib/stores/audioStore';
  
  let isPlaying = false;
  
  // Echte UI
  // Echte UI
  const wrapper = document.getElementById('iamf-player-wrapper');
  const playButtonEl = document.getElementById('iamf-play-button');
  const playButton = playButtonEl instanceof HTMLButtonElement ? playButtonEl : null;
  const statusText = document.getElementById('iamf-status');
  // Dummy UI
  let dummyPlayButton: HTMLButtonElement | null = null;
  let dummyDemoFileDropdown: HTMLSelectElement | null = null;

  // --- 1. Skript-Ladefunktion (unverändert) ---
  function loadScript(src: string) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve(true);
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // --- 2. Haupt-Ladefunktion (unverändert) ---
  async function loadAudioBundle() {
    try {
      await loadScript('/app_bundle.js');
      console.log("IAMF-Skript geladen.");
    } catch (err) {
      console.error('Fehler beim Laden der IAMF-Skripte:', err);
      if (statusText) statusText.textContent = 'Error: Audio Engine failed.';
      return;
    }
    // Starte die (neue) vereinfachte Polling-Logik
    pollForWorkersReady(); 
  }

  // --- 3. (VEREINFACHT) Warten, bis Worker bereit sind ---
  function pollForWorkersReady() {
    // Finde die Dummy-Elemente
    const btn = document.getElementById('playPauseButton');
    const dropdown = document.getElementById('demoFile');
    
    dummyPlayButton = btn instanceof HTMLButtonElement ? btn : null;
    dummyDemoFileDropdown = dropdown instanceof HTMLSelectElement ? dropdown : null;

    if (!dummyPlayButton || !dummyDemoFileDropdown) {
      // app_bundle.js hat die Elemente noch nicht gefunden
      setTimeout(pollForWorkersReady, 50);
      return;
    }

    // JETZT IST DIE LOGIK KORREKT:
    // Wir warten, bis app_bundle.js (nach "2 workers ready")
    // das Dropdown-Menü (das 'disabled' gestartet ist) AKTIVIERT.
    if (dummyDemoFileDropdown.disabled) {
      // Worker laden noch...
      setTimeout(pollForWorkersReady, 50);
      return;
    }

    // Worker sind bereit!
    console.log("IAMF Worker sind bereit.");
    
    // Trigger das Laden der .iamf-Datei
    dummyDemoFileDropdown.dispatchEvent(new Event('change', { 'bubbles': true }));
    console.log("Laden der .iamf-Datei getriggert.");

    pollForAudioFileLoaded();
  }

  // --- 4. Warten, bis die Audio-Datei geladen ist ---
  function pollForAudioFileLoaded() {
    // app_bundle.js deaktiviert den Play-Button, während die .iamf-Datei lädt.
    if (!dummyPlayButton || dummyPlayButton.disabled) {
      // Audio-Datei lädt noch...
      setTimeout(pollForAudioFileLoaded, 100);
      return;
    }

    console.log("IAMF ist abspielbereit.");
    if (statusText) statusText.style.display = 'none';
    if (playButton) playButton.disabled = false;
  }

  // --- 5. UI verbinden ---
  if (playButton) {
    playButton.addEventListener('click', () => {
      if (!dummyPlayButton) return;

      // Initialize/Resume Audio Context on user interaction
      resumeAudioContext();
      
      // Connect to audio elements for signal extraction
      const stereoEl = document.getElementById('stereoPlayback');
      const binauralEl = document.getElementById('binauralPlayback');
      const videoEl = document.getElementById('videoPlayback');
      
      if (stereoEl instanceof HTMLMediaElement) connectAudioElement(stereoEl);
      if (binauralEl instanceof HTMLMediaElement) connectAudioElement(binauralEl);
      if (videoEl instanceof HTMLMediaElement) connectAudioElement(videoEl);

      dummyPlayButton.click();
      isPlaying = !isPlaying;
      if (wrapper) {
        wrapper.classList.toggle('is-playing', isPlaying);
      }
    });
  }

  // --- 6. Theme-Verbindung  ---
  onSet(theme, ({ newValue }) => {
    if (wrapper) wrapper.classList.toggle('dark-mode', newValue === 'dark');
  });
  const currentTheme = theme.get();
  if (wrapper) wrapper.classList.toggle('dark-mode', currentTheme === 'dark');

  // --- 7. Start ---
  document.addEventListener('DOMContentLoaded', loadAudioBundle);
</script>


<style>
  #iamf-player-wrapper {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 1rem;
    background: rgba(240, 240, 240, 0.9);
    border-radius: 12px;
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: background 0.3s, color 0.3s, box-shadow 0.2s ease-out;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    /* Der Wrapper muss klickbar sein */
    pointer-events: auto;
    
    /* Dynamic lighting effects - always defined to prevent layout shifts */
    --light-dx: calc(var(--light-x, 50vw) - 50vw);
    --light-dy: calc(var(--light-y, 50vh) - 50vh);
    --light-proximity: var(--light-intensity, 0);
    
    /* Shadow offset - opposite direction from light */
    --shadow-offset-x: calc(var(--light-dx) * -0.08);
    --shadow-offset-y: calc(var(--light-dy) * -0.08);
    --shadow-blur: calc(12px + (var(--light-intensity, 0) * 20px) + (var(--light-proximity) * 15px));
    --glow-intensity: calc(var(--light-intensity, 0) * var(--light-proximity) * 0.4);
    
    /* Always apply shadow, intensity controlled by CSS vars - Theme-based glow */
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.1),
      var(--shadow-offset-x) var(--shadow-offset-y) var(--shadow-blur) rgba(0, 0, 0, 0.3),
      0 0 calc(25px * var(--glow-intensity)) rgba(240, 245, 255, var(--glow-intensity));
  }
  #iamf-player-wrapper.dark-mode {
    background: rgba(51, 51, 51, 0.9);
    color: #f0f0f0;
  }

  #iamf-play-button {
    display: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: #fff;
    color: #111;
    flex-shrink: 0;
    align-items: center;
    justify-content: center;
    transition: background 0.3s, color 0.3s, transform 0.2s, box-shadow 0.2s ease-out;
    position: relative;
    
    /* Dynamic lighting effects for button */
    --light-dx: calc(var(--light-x, 50vw) - 50vw);
    --light-dy: calc(var(--light-y, 50vh) - 50vh);
    --light-proximity: var(--light-intensity, 0);
    
    /* Button shadow offset */
    --btn-shadow-offset-x: calc(var(--light-dx) * -0.06);
    --btn-shadow-offset-y: calc(var(--light-dy) * -0.06);
    --btn-shadow-blur: calc(8px + (var(--light-intensity, 0) * 12px) + (var(--light-proximity) * 8px));
    --btn-glow-intensity: calc(var(--light-intensity, 0) * var(--light-proximity) * 0.5);
    
    /* Always apply shadow - Theme-based glow */
    box-shadow: 
      var(--btn-shadow-offset-x) var(--btn-shadow-offset-y) var(--btn-shadow-blur) rgba(0, 0, 0, 0.3),
      0 0 calc(15px * var(--btn-glow-intensity)) rgba(240, 245, 255, var(--btn-glow-intensity)),
      inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }
  #iamf-play-button:not(:disabled) {
    display: flex;
  }
  #iamf-player-wrapper.dark-mode #iamf-play-button {
    background: #555;
    color: #eee;
  }
  #iamf-play-button:hover {
    transform: scale(1.05);
    --btn-glow-intensity: calc((var(--light-intensity, 0) * var(--light-proximity) * 0.7) + 0.2);
  }

  #iamf-status {
    font-size: 0.9rem;
    color: #333;
    margin: 0;
    transition: text-shadow 0.2s ease-out;
    
    /* Dynamic text shadow for status text */
    --light-dx: calc(var(--light-x, 50vw) - 50vw);
    --light-dy: calc(var(--light-y, 50vh) - 50vh);
    --light-proximity: var(--light-intensity, 0);
    --text-glow-intensity: calc(var(--light-intensity, 0) * var(--light-proximity) * 0.4);
    
    /* Theme-based glow: cool white for dark theme */
    text-shadow: 
      0 0 calc(3px * var(--text-glow-intensity)) rgba(240, 245, 255, var(--text-glow-intensity)),
      0 1px 2px rgba(0, 0, 0, 0.2);
  }
  #iamf-player-wrapper.dark-mode #iamf-status {
    color: #ccc;
  }

  .icon-pause,
  #iamf-player-wrapper.is-playing .icon-play {
    display: none;
  }
  .icon-play,
  #iamf-player-wrapper.is-playing .icon-pause {
    display: inline-block;
  }
  .icon-play, .icon-pause {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
    fill: currentColor;
  }
</style>